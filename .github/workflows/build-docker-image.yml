name: Build Custom Kamailio Docker Image

on:
  push:
    branches:
      - '6.0'
  workflow_dispatch:
    inputs:
      tag_suffix:
        description: 'Optional tag suffix (e.g., -test, -alpha)'
        required: false
        default: ''

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: bigx333/kamailio
  DIST: bullseye
  VERSION: 6.0

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout forked Kamailio repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Clone pkg-kamailio-docker
        run: |
          git clone https://github.com/kamailio/pkg-kamailio-docker.git /tmp/pkg-kamailio-docker
          cd /tmp/pkg-kamailio-docker
          echo "Using pkg-kamailio-docker at commit: $(git rev-parse HEAD)"

      - name: Prepare source directory
        run: |
          # Create src directory expected by pkg-kamailio-docker
          mkdir -p /tmp/pkg-kamailio-docker/src

          # Copy current repository (our fork) to the src directory
          cp -r $GITHUB_WORKSPACE/* /tmp/pkg-kamailio-docker/src/
          cp -r $GITHUB_WORKSPACE/.git /tmp/pkg-kamailio-docker/src/

          # Verify pkg directory structure exists
          if [ ! -d "/tmp/pkg-kamailio-docker/src/pkg/kamailio/deb/$DIST" ]; then
            echo "Error: Debian packaging metadata not found at pkg/kamailio/deb/$DIST"
            echo "Available distributions:"
            ls -la /tmp/pkg-kamailio-docker/src/pkg/kamailio/deb/ || true
            exit 1
          fi

      - name: Generate Dockerfile
        run: |
          cd /tmp/pkg-kamailio-docker
          bash create_dockerfile.sh $DIST

      - name: Build Kamailio packages
        run: |
          cd /tmp/pkg-kamailio-docker/$DIST
          docker build --tag kamailio-builder:$VERSION-$DIST .

      - name: Extract built packages
        run: |
          # Create container from builder image
          CONTAINER_ID=$(docker create kamailio-builder:$VERSION-$DIST)

          # Create directory for extracted packages
          mkdir -p /tmp/kamailio-packages

          # Extract .deb packages from the build container
          # Note: Adjust the path based on where pkg-kamailio-docker places built packages
          docker cp $CONTAINER_ID:/code /tmp/kamailio-packages/ || \
          docker cp $CONTAINER_ID:/build /tmp/kamailio-packages/ || \
          docker cp $CONTAINER_ID:/tmp /tmp/kamailio-packages/ || true

          # Cleanup
          docker rm $CONTAINER_ID

          # Find and list all .deb packages
          echo "Built packages:"
          find /tmp/kamailio-packages -name "*.deb" -type f

      - name: Create runtime Dockerfile
        run: |
          # Get git short SHA for tagging
          cd $GITHUB_WORKSPACE
          GIT_SHORT_SHA=$(git rev-parse --short HEAD)

          # Create runtime Dockerfile
          cat > /tmp/Dockerfile.runtime << 'EOF'
          FROM debian:bullseye-slim

          # Install runtime dependencies
          RUN apt-get update && apt-get install -y \
              ca-certificates \
              libssl1.1 \
              libpq5 \
              libmariadb3 \
              libhiredis0.14 \
              libmongoc-1.0-0 \
              libcurl4 \
              libpcre3 \
              libxml2 \
              libunistring2 \
              libmaxminddb0 \
              libjansson4 \
              && rm -rf /var/lib/apt/lists/*

          # Copy and install built Kamailio packages
          COPY kamailio-packages /tmp/packages
          RUN find /tmp/packages -name "kamailio*.deb" -type f -exec dpkg -i {} + || apt-get install -f -y && \
              rm -rf /tmp/packages

          # Create required directories
          RUN mkdir -p /var/run/kamailio /etc/kamailio

          # Expose standard Kamailio ports
          EXPOSE 5060/udp 5060/tcp 5061/tcp

          # Set working directory
          WORKDIR /etc/kamailio

          # Default command
          CMD ["kamailio", "-DD", "-E"]
          EOF

          echo "GIT_SHORT_SHA=$GIT_SHORT_SHA" >> $GITHUB_ENV

      - name: Prepare build context for runtime image
        run: |
          mkdir -p /tmp/runtime-build
          cp /tmp/Dockerfile.runtime /tmp/runtime-build/Dockerfile
          cp -r /tmp/kamailio-packages /tmp/runtime-build/

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ env.VERSION }}-${{ env.DIST }}-custom${{ github.event.inputs.tag_suffix }}
            type=raw,value=${{ env.VERSION }}-${{ env.DIST }}-custom-${{ env.GIT_SHORT_SHA }}
            type=raw,value=latest-${{ env.DIST }}

      - name: Build and push runtime image
        uses: docker/build-push-action@v5
        with:
          context: /tmp/runtime-build
          file: /tmp/runtime-build/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image tags
        run: |
          echo "## Built and pushed images:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Primary tag:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}-${{ env.DIST }}-custom\`" >> $GITHUB_STEP_SUMMARY
